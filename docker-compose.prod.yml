services:
  # Next.js 앱 (프로덕션)
  app:
    image: ghcr.io/donggunlim/kobuscheckseat:app-latest
    container_name: kobus-app
    command: ["./entrypoint.app.sh"]
    environment:
      - NODE_ENV=production
      - TZ=Asia/Seoul
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=${REDIS_HOST:-redis-queue}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_TRUST_HOST=${AUTH_TRUST_HOST}
      - KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
      - KAKAO_CLIENT_SECRET_KEY=${KAKAO_CLIENT_SECRET_KEY}
    networks:
      - home-network
    restart: always

  # Worker (프로덕션)
  # 실행 시 --scale worker=N 으로 개수 조정
  # 예: docker compose up -d --scale worker=2
  worker:
    image: ghcr.io/donggunlim/kobuscheckseat:worker-latest
    command: ["./entrypoint.worker.sh"]
    environment:
      - NODE_ENV=production
      - TZ=Asia/Seoul
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=${REDIS_HOST:-redis-queue}
      - REDIS_PORT=${REDIS_PORT:-6379}
    networks:
      - home-network
    restart: always

networks:
  home-network:
    external: true # 기존에 생성된 외부 네트워크 사용
